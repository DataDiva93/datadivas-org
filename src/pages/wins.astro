---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Wins — Data Divas">
  <main class="container" style="padding-top: var(--space-2xl); padding-bottom: var(--space-2xl);">

    <!-- Hero -->
    <section class="hero">
      <h1>Wins</h1>
      <p class="hero-subtitle">
        <strong>Proof over hype. Receipts over theory.</strong>
      </p>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-xl);">
        Every shipped lab, every demo, every repo. This is where we celebrate the work.
      </p>
      <div class="cta-group">
        <a href="https://discord.gg/XXUk8y5MTT" class="btn btn-primary">submit_win()</a>
        <a href="/ship-week" class="btn btn-outline">join_ship_week()</a>
      </div>
    </section>

    <hr class="code-divider" />

    <!-- Leaderboard Section -->
    <section>
      <div class="section-header">
        <h2>// Leaderboard</h2>
        <div class="time-filter">
          <button class="filter-btn active" data-window="30d">Last 30 Days</button>
          <button class="filter-btn" data-window="all">All Time</button>
        </div>
      </div>

      <div id="leaderboard-container">
        <div class="loading">
          <code>$ loading leaderboard...</code>
        </div>
      </div>
    </section>

    <hr class="code-divider" />

    <!-- Recent Wins Section -->
    <section>
      <h2>// Recent Wins</h2>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
        Latest shipped projects from the community.
      </p>

      <div id="wins-container">
        <div class="loading">
          <code>$ loading wins...</code>
        </div>
      </div>

      <div class="load-more-container">
        <button id="load-more-btn" class="btn btn-outline" style="display: none;">
          load_more()
        </button>
      </div>
    </section>

    <!-- Submit Instructions -->
    <section class="submit-section">
      <div class="card">
        <h2 style="margin-top: 0;">// Submit Your Win</h2>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
          Shipped something? Share it with the community!
        </p>

        <div class="submit-methods">
          <div class="submit-method">
            <span class="badge badge-green">recommended</span>
            <h3 style="margin: var(--space-sm) 0;">Discord</h3>
            <p>Post in the #wins channel with your repo, demo, and write-up.</p>
            <a href="https://discord.gg/XXUk8y5MTT" class="btn btn-primary">discord.join()</a>
          </div>

          <div class="submit-method">
            <span class="badge badge-cyan">advanced</span>
            <h3 style="margin: var(--space-sm) 0;">API</h3>
            <p>POST to <code>/api/wins</code> with your submission data.</p>
            <button class="btn btn-outline" onclick="document.getElementById('api-docs').style.display='block'">
              view_api_docs()
            </button>
          </div>
        </div>

        <div id="api-docs" style="display: none; margin-top: var(--space-lg);">
          <h3>API Documentation</h3>
          <pre><code>POST /api/wins
Content-Type: application/json

{
  "handle": "your-discord-handle",
  "repo_url": "https://github.com/user/repo",
  "demo_url": "https://demo.example.com", // optional
  "summary": "Brief description of what you built",
  "broke_fix": "What broke and how you fixed it",
  "validation": "How you validated it works",
  "resume_bullets": "• Bullet 1\n• Bullet 2"
}</code></pre>
        </div>
      </div>
    </section>

  </main>
</BaseLayout>

<style>
  .hero {
    text-align: center;
    margin-bottom: var(--space-2xl);
  }

  .hero h1 {
    font-size: 3rem;
    margin-bottom: var(--space-lg);
  }

  .hero-subtitle {
    font-size: 1.25rem;
    margin-bottom: var(--space-md);
    color: var(--text-primary);
  }

  .cta-group {
    display: flex;
    gap: var(--space-md);
    justify-content: center;
    flex-wrap: wrap;
  }

  /* Section Header */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .time-filter {
    display: flex;
    gap: var(--space-xs);
  }

  .filter-btn {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    padding: var(--space-xs) var(--space-md);
    background: transparent;
    border: 1px solid var(--border-default);
    color: var(--text-secondary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-btn:hover {
    border-color: var(--purple-500);
    color: var(--purple-300);
  }

  .filter-btn.active {
    background: var(--purple-600);
    border-color: var(--purple-500);
    color: white;
  }

  /* Loading State */
  .loading {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--text-secondary);
  }

  .loading code {
    font-family: var(--font-mono);
    font-size: 1rem;
  }

  /* Leaderboard */
  .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--font-mono);
  }

  .leaderboard-table thead {
    background: var(--bg-card);
    border-bottom: 2px solid var(--border-bright);
  }

  .leaderboard-table th {
    text-align: left;
    padding: var(--space-md);
    font-weight: 700;
    color: var(--purple-300);
    text-transform: uppercase;
    font-size: 0.875rem;
    letter-spacing: 0.05em;
  }

  .leaderboard-table td {
    padding: var(--space-md);
    border-bottom: 1px solid var(--border-subtle);
  }

  .leaderboard-table tbody tr {
    transition: background 0.2s ease;
  }

  .leaderboard-table tbody tr:hover {
    background: var(--bg-card-hover);
  }

  .rank {
    font-weight: 700;
    color: var(--purple-400);
    min-width: 50px;
  }

  .rank.top-1 { color: var(--orange); font-size: 1.2rem; }
  .rank.top-2 { color: var(--cyan); }
  .rank.top-3 { color: var(--green); }

  .handle {
    font-weight: 600;
    color: var(--text-primary);
  }

  .points {
    color: var(--purple-300);
    font-weight: 700;
  }

  /* Win Cards */
  .win-grid {
    display: grid;
    gap: var(--space-lg);
  }

  .win-card {
    background: var(--bg-card);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    padding: var(--space-xl);
    transition: all 0.3s ease;
  }

  .win-card:hover {
    border-color: var(--purple-500);
    box-shadow: var(--shadow-purple-md);
    transform: translateY(-2px);
  }

  .win-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-md);
    gap: var(--space-md);
  }

  .win-meta {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }

  .win-handle {
    font-family: var(--font-mono);
    font-weight: 700;
    color: var(--purple-300);
  }

  .win-date {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--text-tertiary);
  }

  .win-summary {
    margin-bottom: var(--space-md);
    color: var(--text-primary);
  }

  .win-links {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }

  .win-link {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    padding: var(--space-xs) var(--space-sm);
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid var(--purple-700);
    color: var(--purple-300);
    text-decoration: none;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
  }

  .win-link:hover {
    border-color: var(--purple-500);
    background: rgba(139, 92, 246, 0.2);
    transform: translateY(-1px);
  }

  /* Load More */
  .load-more-container {
    text-align: center;
    margin-top: var(--space-xl);
  }

  /* Submit Section */
  .submit-section {
    margin-top: var(--space-2xl);
  }

  .submit-methods {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-lg);
  }

  .submit-method {
    padding: var(--space-lg);
    background: var(--bg-darker);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
  }

  .submit-method h3 {
    font-family: var(--font-mono);
    color: var(--text-primary);
  }

  .submit-method p {
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
    font-size: 0.95rem;
  }

  #api-docs {
    padding: var(--space-lg);
    background: var(--bg-darker);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
  }

  #api-docs h3 {
    font-family: var(--font-mono);
    color: var(--purple-300);
    margin-bottom: var(--space-md);
  }

  #api-docs pre {
    margin: 0;
  }

  /* Utility Classes */
  .text-secondary {
    color: var(--text-secondary);
  }

  .text-tertiary {
    color: var(--text-tertiary);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero h1 {
      font-size: 2rem;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .leaderboard-table {
      font-size: 0.875rem;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: var(--space-sm);
    }
  }
</style>

<script>
  // Fetch and display leaderboard
  async function loadLeaderboard(window = '30d') {
    const container = document.getElementById('leaderboard-container');
    if (!container) return;

    container.innerHTML = '<div class="loading"><code>$ loading leaderboard...</code></div>';

    try {
      const response = await fetch(`/api/leaderboard?window=${window}`);
      const data = await response.json();

      if (!response.ok || data.ok === false) {
        const message = data.message || 'Leaderboard not configured yet.';
        const hint = data.hint || 'Check back soon!';
        container.innerHTML = '<div class="card"><p class="text-secondary">' + message + '</p><p class="text-tertiary" style="font-size: 0.875rem; margin-top: var(--space-sm);">' + hint + '</p></div>';
        return;
      }

      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<div class="card"><p class="text-secondary">No wins yet. Be the first to ship!</p></div>';
        return;
      }

      const table = `
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Handle</th>
              <th>Wins</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody>
            ${data.map((entry, idx) => {
              const rank = idx + 1;
              const rankClass = rank === 1 ? 'top-1' : rank === 2 ? 'top-2' : rank === 3 ? 'top-3' : '';
              return `
                <tr>
                  <td class="rank ${rankClass}">#${rank}</td>
                  <td class="handle">${escapeHtml(entry.handle)}</td>
                  <td>${entry.wins}</td>
                  <td class="points">${entry.points}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = table;
    } catch (error) {
      container.innerHTML = '<div class="card"><p class="text-secondary">Failed to load leaderboard. Please try again later.</p></div>';
    }
  }

  // Fetch and display recent wins
  let currentLimit = 10;
  async function loadWins() {
    const container = document.getElementById('wins-container');
    const loadMoreBtn = document.getElementById('load-more-btn');
    if (!container) return;

    container.innerHTML = '<div class="loading"><code>$ loading wins...</code></div>';

    try {
      const response = await fetch(`/api/wins?limit=${currentLimit}`);
      const data = await response.json();

      if (!response.ok || data.ok === false) {
        const message = data.message || 'Wins not configured yet.';
        const hint = data.hint || 'Share your first win in Discord!';
        container.innerHTML = '<div class="card"><p class="text-secondary">' + message + '</p><p class="text-tertiary" style="font-size: 0.875rem; margin-top: var(--space-sm);">' + hint + '</p></div>';
        return;
      }

      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<div class="card"><p class="text-secondary">No wins yet. Ship a lab and be the first!</p></div>';
        return;
      }

      const winsHtml = `
        <div class="win-grid">
          ${data.map(win => `
            <div class="win-card">
              <div class="win-card-header">
                <div class="win-meta">
                  <span class="win-handle">${escapeHtml(win.handle)}</span>
                  ${win.featured ? '<span class="badge badge-pink">featured</span>' : ''}
                </div>
                <span class="win-date">${formatDate(win.created_at)}</span>
              </div>
              <div class="win-summary">${escapeHtml(win.summary)}</div>
              <div class="win-links">
                <a href="${escapeHtml(win.repo_url)}" class="win-link" target="_blank" rel="noopener">
                  view_repo()
                </a>
                ${win.demo_url ? `
                  <a href="${escapeHtml(win.demo_url)}" class="win-link" target="_blank" rel="noopener">
                    view_demo()
                  </a>
                ` : ''}
                <span class="tech-badge">${win.points} pts</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      container.innerHTML = winsHtml;

      if (data.length >= currentLimit && loadMoreBtn) {
        loadMoreBtn.style.display = 'inline-block';
      }
    } catch (error) {
      container.innerHTML = '<div class="card"><p class="text-secondary">Failed to load wins. Please try again later.</p></div>';
    }
  }

  // Helper functions
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'today';
    if (diffDays === 1) return 'yesterday';
    if (diffDays < 7) return `${diffDays}d ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
    return date.toLocaleDateString();
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    loadLeaderboard('30d');
    loadWins();

    // Time filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const window = btn.getAttribute('data-window');
        if (window) loadLeaderboard(window);
      });
    });

    // Load more button
    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', () => {
        currentLimit += 10;
        loadWins();
      });
    }
  });
</script>
